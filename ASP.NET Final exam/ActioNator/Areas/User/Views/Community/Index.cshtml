@model IEnumerable<ActioNator.ViewModels.Community.PostCardViewModel>
@{
    ViewData["Title"] = "Community";
    Layout = "_Layout";
}

@Html.AntiForgeryToken()

<div class="container mx-auto px-4 py-8 flex justify-center">
    <div class="flex flex-col md:flex-row gap-6 w-full max-w-5xl">

        <!-- Main content area -->
        <div class="w-full md:w-3/4 lg:w-4/5">
            <!-- Create post card -->
            <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <div class="flex items-center">
                    <img src="@((ViewBag.CurrentUserProfilePictureUrl as string) ?? "/images/placeholder-image.png")"
                         alt="Your profile"
                         class="h-10 w-10 rounded-full object-cover flex-shrink-0"
                         onerror="this.src='/images/placeholder-image.png'" />
                    <button type="button" class="create-post-trigger ml-3 bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-full flex-grow text-left">
                        What's on your mind?
                    </button>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="bg-facebook-card rounded-lg shadow mb-4 p-4" x-data="{ showFilters: false, filters: { status: '@ViewBag.CurrentStatus', dateRange: 'all-time' } }">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Posts</h3>
                    <button @@click="showFilters = !showFilters" class="text-blue-600 hover:text-blue-800 flex items-center">
                        <span>Filter</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" :class="{'rotate-180': showFilters}" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <div x-show="showFilters" x-transition class="mt-4 space-y-4">
                    @if (ViewBag.IsAdmin == true)
                    {
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                            <div class="flex space-x-2">
                                <a href="@Url.Action("Index", "Community", new { status = "all" })" class="px-3 py-1 rounded-full text-sm @(ViewBag.CurrentStatus == "all" ? "bg-blue-600 text-white" : "bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300")">All</a>
                                <a href="@Url.Action("Index", "Community", new { status = "active" })" class="px-3 py-1 rounded-full text-sm @(ViewBag.CurrentStatus == "active" ? "bg-blue-600 text-white" : "bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300")">Active</a>
                                <a href="@Url.Action("Index", "Community", new { status = "deleted" })" class="px-3 py-1 rounded-full text-sm @(ViewBag.CurrentStatus == "deleted" ? "bg-blue-600 text-white" : "bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300")">Deleted</a>
                            </div>
                        </div>
                    }
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date Range</label>
                        <div class="flex space-x-2">
                            <button @@click="filters.dateRange = 'all-time'" :class="{'bg-blue-600 text-white': filters.dateRange === 'all-time', 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300': filters.dateRange !== 'all-time'}" class="px-3 py-1 rounded-full text-sm">All Time</button>
                            <button @@click="filters.dateRange = 'today'" :class="{'bg-blue-600 text-white': filters.dateRange === 'today', 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300': filters.dateRange !== 'today'}" class="px-3 py-1 rounded-full text-sm">Today</button>
                            <button @@click="filters.dateRange = 'this-week'" :class="{'bg-blue-600 text-white': filters.dateRange === 'this-week', 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300': filters.dateRange !== 'this-week'}" class="px-3 py-1 rounded-full text-sm">This Week</button>
                            <button @@click="filters.dateRange = 'this-month'" :class="{'bg-blue-600 text-white': filters.dateRange === 'this-month', 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300': filters.dateRange !== 'this-month'}" class="px-3 py-1 rounded-full text-sm">This Month</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posts feed -->
            <div id="posts-container" class="space-y-6">
                @if (Model != null && Model.Any())
                {
                    foreach (var post in Model)
                    {
                        <partial name="_PostCardPartial" model="post" />
                    }
                }
                else
                {
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center">
                        <p class="text-gray-500 dark:text-gray-400">No posts yet. Be the first to share something!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Include modal partial for deletion and reporting -->
<partial name="_ModalPartial" />

@section Scripts {
    <!-- SignalR client library (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.5/dist/browser/signalr.min.js" crossorigin="anonymous"></script>
    
    <!-- Community hub client -->
    <script src="~/js/communityHub.js" asp-append-version="true"></script>

    <script>
        // Expose current user's avatar URL for the Create Post modal
        window.currentUserAvatarUrl = '@(((ViewBag.CurrentUserProfilePictureUrl as string) ?? "/images/placeholder-image.png").Replace("'", "\\'"))';
    </script>

    <script src="~/js/createPost.js" asp-append-version="true"></script>
}

@section Styles {
    <link rel="stylesheet" href="/css/post.css">
}